# OmniFocus Workflows
# Managed by chezmoi - DO NOT EDIT DIRECTLY

# ==================================
# OmniFocus Integration Workflows
# ==================================

{{ if or (eq .preferences.enable_omnifocus true) (eq .enable_productivity true) -}}
# Add a task to OmniFocus inbox
of-add() {
  local task_name=$1
  local note=${2:-""}
  local due_date=${3:-""}

  if [[ -z "$task_name" ]]; then
    echo "Usage: of-add <task-name> [note] [due-date]"
    echo "Example: of-add \"Buy groceries\" \"Milk, eggs, bread\" \"tomorrow 6pm\""
    return 1
  fi

  # Check if running on macOS
  if [[ "$(uname)" != "Darwin" ]]; then
    echo "Error: OmniFocus integration is only available on macOS."
    return 1
  fi

  if ! osascript -e 'id of application "OmniFocus"' &>/dev/null; then
    echo "Error: OmniFocus is not installed."
    return 1
  fi

  # Construct the AppleScript
  local script="tell application \"OmniFocus\"
  tell default document
    set theTask to make new inbox task with properties {name:\"$task_name\""

  # Add note if provided
  if [[ -n "$note" ]]; then
    script+=", note:\"$note\""
  fi

  # Add due date if provided
  if [[ -n "$due_date" ]]; then
    script+=", due date:date \"$due_date\""
  fi

  # Close the script
  script+="}
  end tell
end tell"

  osascript -e "$script"

  echo "Task \"$task_name\" added to OmniFocus inbox"
}

# Add a task to a specific OmniFocus project
of-add-to-project() {
  local project_name=$1
  local task_name=$2
  local note=${3:-""}
  local due_date=${4:-""}

  if [[ -z "$project_name" || -z "$task_name" ]]; then
    echo "Usage: of-add-to-project <project-name> <task-name> [note] [due-date]"
    echo "Example: of-add-to-project \"Home\" \"Fix the sink\" \"Bathroom sink\" \"this weekend\""
    return 1
  fi

  # Check if running on macOS
  if [[ "$(uname)" != "Darwin" ]]; then
    echo "Error: OmniFocus integration is only available on macOS."
    return 1
  fi

  if ! osascript -e 'id of application "OmniFocus"' &>/dev/null; then
    echo "Error: OmniFocus is not installed."
    return 1
  fi

  # Construct the AppleScript
  local script="tell application \"OmniFocus\"
  tell default document
    set theProject to first flattened project where name = \"$project_name\"
    tell theProject
      set theTask to make new task with properties {name:\"$task_name\""

  # Add note if provided
  if [[ -n "$note" ]]; then
    script+=", note:\"$note\""
  fi

  # Add due date if provided
  if [[ -n "$due_date" ]]; then
    script+=", due date:date \"$due_date\""
  fi

  # Close the script
  script+="}
    end tell
  end tell
end tell"

  osascript -e "$script" 2>/dev/null

  # Check if the command was successful
  if [[ $? -ne 0 ]]; then
    echo "Error: Project \"$project_name\" not found in OmniFocus."
    return 1
  fi

  echo "Task \"$task_name\" added to OmniFocus project \"$project_name\""
}

# List all OmniFocus projects
of-projects() {
  local filter=${1:-""}

  # Check if running on macOS
  if [[ "$(uname)" != "Darwin" ]]; then
    echo "Error: OmniFocus integration is only available on macOS."
    return 1
  fi

  if ! osascript -e 'id of application "OmniFocus"' &>/dev/null; then
    echo "Error: OmniFocus is not installed."
    return 1
  fi

  # Construct the AppleScript
  local script="tell application \"OmniFocus\"
  tell default document
    set theProjects to name of flattened projects"

  # Add filter if provided
  if [[ -n "$filter" ]]; then
    script+=" where name contains \"$filter\""
  fi

  # Close the script
  script+="
  end tell
end tell"

  local result=$(osascript -e "$script" 2>/dev/null)

  # Check if the command was successful
  if [[ $? -ne 0 ]]; then
    echo "Error: Failed to retrieve OmniFocus projects."
    return 1
  fi

  # Format and display the projects
  echo "OmniFocus Projects:"
  echo "$result" | tr ',' '\n' | sed 's/^ */- /'
}

# List all tasks in a specific OmniFocus project
of-tasks() {
  local project_name=$1
  local include_completed=${2:-false}

  if [[ -z "$project_name" ]]; then
    echo "Usage: of-tasks <project-name> [include-completed]"
    echo "Example: of-tasks \"Home\" true"
    return 1
  fi

  # Check if running on macOS
  if [[ "$(uname)" != "Darwin" ]]; then
    echo "Error: OmniFocus integration is only available on macOS."
    return 1
  fi

  if ! osascript -e 'id of application "OmniFocus"' &>/dev/null; then
    echo "Error: OmniFocus is not installed."
    return 1
  fi

  # Construct the AppleScript
  local script="tell application \"OmniFocus\"
  tell default document
    set theProject to first flattened project where name = \"$project_name\"
    set theTasks to {}
    tell theProject
      set projectTasks to every task"

  # Add filter for completed tasks if needed
  if [[ "$include_completed" != "true" ]]; then
    script+=" where completed is false"
  fi

  # Continue the script
  script+="
      repeat with t in projectTasks
        set end of theTasks to {name:name of t, completed:completed of t}
      end repeat
    end tell
    set taskList to {}
    repeat with t in theTasks
      if completed of t then
        set c to \"[âœ“] \"
      else
        set c to \"[ ] \"
      end if
      set end of taskList to c & (name of t)
    end repeat
    return taskList
  end tell
end tell"

  local result=$(osascript -e "$script" 2>/dev/null)

  # Check if the command was successful
  if [[ $? -ne 0 ]]; then
    echo "Error: Project \"$project_name\" not found in OmniFocus."
    return 1
  fi

  # Format and display the tasks
  echo "Tasks in project \"$project_name\":"
  echo "$result" | tr ',' '\n' | sed 's/^ *//'
}

# Mark an OmniFocus task as completed
of-complete() {
  local task_name=$1

  if [[ -z "$task_name" ]]; then
    echo "Usage: of-complete <task-name>"
    echo "Example: of-complete \"Buy groceries\""
    return 1
  fi

  # Check if running on macOS
  if [[ "$(uname)" != "Darwin" ]]; then
    echo "Error: OmniFocus integration is only available on macOS."
    return 1
  fi

  if ! osascript -e 'id of application "OmniFocus"' &>/dev/null; then
    echo "Error: OmniFocus is not installed."
    return 1
  fi

  # Construct the AppleScript
  local script="tell application \"OmniFocus\"
  tell default document
    set matchingTasks to (flattened tasks where name = \"$task_name\" and completed is false)
    if length of matchingTasks > 0 then
      repeat with t in matchingTasks
        set completed of t to true
      end repeat
      return true
    else
      return false
    end if
  end tell
end tell"

  local result=$(osascript -e "$script" 2>/dev/null)

  # Check if any tasks were marked as completed
  if [[ "$result" == "true" ]]; then
    echo "Task \"$task_name\" marked as completed in OmniFocus"
  else
    echo "Error: No incomplete tasks found with the name \"$task_name\""
    return 1
  fi
}

# Search for tasks in OmniFocus
of-search() {
  local search_term=$1
  local context=${2:-"all"}

  if [[ -z "$search_term" ]]; then
    echo "Usage: of-search <search-term> [context]"
    echo "Example: of-search \"groceries\" \"active\""
    echo "Available contexts: all, active, inbox, projects, flagged, due"
    return 1
  fi

  # Check if running on macOS
  if [[ "$(uname)" != "Darwin" ]]; then
    echo "Error: OmniFocus integration is only available on macOS."
    return 1
  fi

  if ! osascript -e 'id of application "OmniFocus"' &>/dev/null; then
    echo "Error: OmniFocus is not installed."
    return 1
  fi

  # Construct the AppleScript based on the search context
  local script="tell application \"OmniFocus\"
  tell default document"

  case "$context" in
    inbox)
      script+="
    set searchTasks to flattened inbox tasks where name contains \"$search_term\" and completed is false"
      ;;
    projects)
      script+="
    set searchTasks to flattened projects where name contains \"$search_term\""
      ;;
    flagged)
      script+="
    set searchTasks to flattened tasks where name contains \"$search_term\" and flagged is true and completed is false"
      ;;
    due)
      script+="
    set searchTasks to flattened tasks where name contains \"$search_term\" and due date is not missing value and completed is false"
      ;;
    active)
      script+="
    set searchTasks to flattened tasks where name contains \"$search_term\" and completed is false"
      ;;
    all|*)
      script+="
    set searchTasks to flattened tasks where name contains \"$search_term\""
      ;;
  esac

  # Continue the script to format results
  script+="
    set taskList to {}
    repeat with t in searchTasks
      set taskName to name of t
      if class of t is task then
        if completed of t then
          set taskStatus to \"[âœ“] \"
        else
          set taskStatus to \"[ ] \"
        end if

        if flagged of t then
          set taskFlag to \"ðŸš© \"
        else
          set taskFlag to \"\"
        end if

        if due date of t is not missing value then
          set dueInfo to \" (due: \" & (due date of t as string) & \")\"
        else
          set dueInfo to \"\"
        end if

        try
          set projectName to name of containing project of t
          set projectInfo to \" [\" & projectName & \"]\"
        on error
          set projectInfo to \" [Inbox]\"
        end try

        set end of taskList to taskStatus & taskFlag & taskName & dueInfo & projectInfo
      else
        set end of taskList to \"ðŸ“‚ \" & taskName
      end if
    end repeat
    return taskList
  end tell
end tell"

  local result=$(osascript -e "$script" 2>/dev/null)

  # Check if the search was successful
  if [[ $? -ne 0 ]]; then
    echo "Error: Failed to search OmniFocus."
    return 1
  fi

  # Display the search results
  if [[ -z "$result" ]]; then
    echo "No matching tasks found for \"$search_term\" in $context."
  else
    echo "Search results for \"$search_term\" in $context:"
    echo "$result" | tr ',' '\n' | sed 's/^ *//'
  fi
}

# Create a new OmniFocus project
of-new-project() {
  local project_name=$1
  local folder_name=${2:-""}

  if [[ -z "$project_name" ]]; then
    echo "Usage: of-new-project <project-name> [folder-name]"
    echo "Example: of-new-project \"Kitchen Remodel\" \"Home\""
    return 1
  fi

  # Check if running on macOS
  if [[ "$(uname)" != "Darwin" ]]; then
    echo "Error: OmniFocus integration is only available on macOS."
    return 1
  fi

  if ! osascript -e 'id of application "OmniFocus"' &>/dev/null; then
    echo "Error: OmniFocus is not installed."
    return 1
  fi

  # Construct the AppleScript
  local script="tell application \"OmniFocus\"
  tell default document"

  # If a folder is specified, create the project in that folder
  if [[ -n "$folder_name" ]]; then
    script+="
    try
      set theFolder to first flattened folder where name = \"$folder_name\"
      tell theFolder
        make new project with properties {name:\"$project_name\"}
      end tell
    on error
      display dialog \"Folder '$folder_name' not found.\" buttons {\"OK\"} default button \"OK\"
      return false
    end try"
  else
    # Otherwise, create the project at the root level
    script+="
    make new project with properties {name:\"$project_name\"}"
  fi

  # Close the script
  script+="
    return true
  end tell
end tell"

  local result=$(osascript -e "$script" 2>/dev/null)

  # Check if the project was created successfully
  if [[ "$result" == "true" ]]; then
    if [[ -n "$folder_name" ]]; then
      echo "Project \"$project_name\" created in OmniFocus folder \"$folder_name\""
    else
      echo "Project \"$project_name\" created in OmniFocus"
    fi
  else
    echo "Error: Failed to create OmniFocus project."
    return 1
  fi
}

# List all OmniFocus folders
of-folders() {
  # Check if running on macOS
  if [[ "$(uname)" != "Darwin" ]]; then
    echo "Error: OmniFocus integration is only available on macOS."
    return 1
  fi

  if ! osascript -e 'id of application "OmniFocus"' &>/dev/null; then
    echo "Error: OmniFocus is not installed."
    return 1
  fi

  # Construct the AppleScript
  local script="tell application \"OmniFocus\"
  tell default document
    set theFolders to name of flattened folders
  end tell
end tell"

  local result=$(osascript -e "$script" 2>/dev/null)

  # Check if the command was successful
  if [[ $? -ne 0 ]]; then
    echo "Error: Failed to retrieve OmniFocus folders."
    return 1
  fi

  # Format and display the folders
  echo "OmniFocus Folders:"
  echo "$result" | tr ',' '\n' | sed 's/^ */- /'
}

# Show tasks due today in OmniFocus
of-today() {
  # Check if running on macOS
  if [[ "$(uname)" != "Darwin" ]]; then
    echo "Error: OmniFocus integration is only available on macOS."
    return 1
  fi

  if ! osascript -e 'id of application "OmniFocus"' &>/dev/null; then
    echo "Error: OmniFocus is not installed."
    return 1
  fi

  # Construct the AppleScript
  local script="tell application \"OmniFocus\"
  tell default document
    set todayTasks to flattened tasks where (due date â‰¤ (current date) and completed is false)
    set taskList to {}
    repeat with t in todayTasks
      set taskName to name of t

      if flagged of t then
        set taskFlag to \"ðŸš© \"
      else
        set taskFlag to \"\"
      end if

      set dueDate to due date of t
      set dueInfo to \" (due: \" & (dueDate as string) & \")\"

      try
        set projectName to name of containing project of t
        set projectInfo to \" [\" & projectName & \"]\"
      on error
        set projectInfo to \" [Inbox]\"
      end try

      set end of taskList to taskFlag & taskName & dueInfo & projectInfo
    end repeat
    return taskList
  end tell
end tell"

  local result=$(osascript -e "$script" 2>/dev/null)

  # Check if the command was successful
  if [[ $? -ne 0 ]]; then
    echo "Error: Failed to retrieve OmniFocus tasks due today."
    return 1
  fi

  # Display the tasks
  if [[ -z "$result" ]]; then
    echo "No tasks due today."
  else
    echo "Tasks due today:"
    echo "$result" | tr ',' '\n' | sed 's/^ */- /'
  fi
}

# Process OmniFocus inbox items to projects
of-process-inbox() {
  # Check if running on macOS
  if [[ "$(uname)" != "Darwin" ]]; then
    echo "Error: OmniFocus integration is only available on macOS."
    return 1
  fi

  if ! osascript -e 'id of application "OmniFocus"' &>/dev/null; then
    echo "Error: OmniFocus is not installed."
    return 1
  fi

  # Get count of inbox items
  local script="tell application \"OmniFocus\"
  tell default document
    set inboxCount to count of inbox tasks where completed is false
    return inboxCount
  end tell
end tell"

  local inbox_count=$(osascript -e "$script" 2>/dev/null)

  echo "You have $inbox_count items in your OmniFocus inbox."

  # Open OmniFocus and show the inbox
  osascript -e 'tell application "OmniFocus" to activate' -e 'tell application "OmniFocus" to tell default document to tell front document window to set perspective name to "Inbox"' &>/dev/null

  echo "Opening OmniFocus to process your inbox..."
  echo "Tips for inbox processing:"
  echo "1. Decide if each item is actionable"
  echo "2. If it can be done in under 2 minutes, do it now"
  echo "3. If not, assign it to a project or delegate it"
  echo "4. Set deadlines only for tasks with real due dates"
}

# Create a new project template in OmniFocus
of-template() {
  local template_name=$1

  if [[ -z "$template_name" ]]; then
    echo "Usage: of-template <template-name>"
    echo "Example: of-template \"Trip Planning\""
    return 1
  fi

  # Check if running on macOS
  if [[ "$(uname)" != "Darwin" ]]; then
    echo "Error: OmniFocus integration is only available on macOS."
    return 1
  fi

  if ! osascript -e 'id of application "OmniFocus"' &>/dev/null; then
    echo "Error: OmniFocus is not installed."
    return 1
  fi

  # Ask for template folder if needed
  local template_folder
  local script="tell application \"OmniFocus\"
  tell default document
    set folderExists to false
    try
      set folderExists to exists first flattened folder where name = \"Templates\"
    end try
    return folderExists
  end tell
end tell"

  local folder_exists=$(osascript -e "$script" 2>/dev/null)

  if [[ "$folder_exists" != "true" ]]; then
    # Create Templates folder
    script="tell application \"OmniFocus\"
    tell default document
      make new folder with properties {name:\"Templates\"}
    end tell
  end tell"
    osascript -e "$script" &>/dev/null
    echo "Created 'Templates' folder in OmniFocus."
  fi

  template_folder="Templates"

  # Ask for template details
  echo "Creating template project \"$template_name\" in OmniFocus..."
  echo "Please enter the tasks for your template, one per line."
  echo "When finished, enter a blank line or type 'done'."

  local tasks=()
  while true; do
    read -p "Task: " task
    if [[ -z "$task" || "$task" == "done" ]]; then
      break
    fi
    tasks+=("$task")
  done

  # Create the template project
  script="tell application \"OmniFocus\"
  tell default document
    set templateFolder to first flattened folder where name = \"$template_folder\"
    tell templateFolder
      set newTemplate to make new project with properties {name:\"$template_name\"}
      tell newTemplate"

  # Add tasks to the template
  for task in "${tasks[@]}"; do
    script+="
        make new task with properties {name:\"$task\"}"
  done

  # Close the script
  script+="
      end tell
    end tell
    return true
  end tell
end tell"

  local result=$(osascript -e "$script" 2>/dev/null)

  # Check if the template was created successfully
  if [[ "$result" == "true" ]]; then
    echo "Template \"$template_name\" created in OmniFocus with ${#tasks[@]} tasks."
  else
    echo "Error: Failed to create OmniFocus template."
    return 1
  fi
}

# Apply a template to create a new project
of-apply-template() {
  local template_name=$1
  local project_name=$2
  local folder_name=${3:-""}

  if [[ -z "$template_name" || -z "$project_name" ]]; then
    echo "Usage: of-apply-template <template-name> <project-name> [folder-name]"
    echo "Example: of-apply-template \"Trip Planning\" \"Summer Vacation 2023\" \"Personal\""
    return 1
  fi

  # Check if running on macOS
  if [[ "$(uname)" != "Darwin" ]]; then
    echo "Error: OmniFocus integration is only available on macOS."
    return 1
  fi

  if ! osascript -e 'id of application "OmniFocus"' &>/dev/null; then
    echo "Error: OmniFocus is not installed."
    return 1
  fi

  local script="tell application \"OmniFocus\"
  tell default document
    set templateExists to false
    try
      set templateExists to exists first flattened project where name = \"$template_name\" and containing folder's name = \"Templates\"
    end try
    return templateExists
  end tell
end tell"

  local template_exists=$(osascript -e "$script" 2>/dev/null)

  if [[ "$template_exists" != "true" ]]; then
    echo "Error: Template \"$template_name\" not found in the Templates folder."
    return 1
  fi

  # Create the new project and copy tasks from the template
  script="tell application \"OmniFocus\"
  tell default document
    set templateProject to first flattened project where name = \"$template_name\" and containing folder's name = \"Templates\"
    set templateTasks to tasks of templateProject"

  # Determine where to create the new project
  if [[ -n "$folder_name" ]]; then
    script+="
    try
      set targetFolder to first flattened folder where name = \"$folder_name\"
      tell targetFolder
        set newProject to make new project with properties {name:\"$project_name\"}
      end tell
    on error
      display dialog \"Folder '$folder_name' not found.\" buttons {\"OK\"} default button \"OK\"
      return false
    end try"
  else
    script+="
    set newProject to make new project with properties {name:\"$project_name\"}"
  fi

  # Copy tasks from the template to the new project
  script+="
    tell newProject
      repeat with t in templateTasks
        set taskName to name of t
        set newTask to make new task with properties {name:taskName}

        # Copy additional properties if needed
        try
          if note of t is not \"\" then
            set note of newTask to note of t
          end if
        end try

        # Copy subtasks if needed
        try
          set subtasks to tasks of t
          if length of subtasks > 0 then
            tell newTask
              repeat with s in subtasks
                make new task with properties {name:name of s}
              end repeat
            end tell
          end if
        end try
      end repeat
    end tell
    return true
  end tell
end tell"

  local result=$(osascript -e "$script" 2>/dev/null)

  # Check if the project was created successfully
  if [[ "$result" == "true" ]]; then
    if [[ -n "$folder_name" ]]; then
      echo "Project \"$project_name\" created in OmniFocus folder \"$folder_name\" using template \"$template_name\"."
    else
      echo "Project \"$project_name\" created in OmniFocus using template \"$template_name\"."
    fi
  else
    echo "Error: Failed to create project from template."
    return 1
  fi
}

# List all OmniFocus templates
of-templates() {
  # Check if running on macOS
  if [[ "$(uname)" != "Darwin" ]]; then
    echo "Error: OmniFocus integration is only available on macOS."
    return 1
  fi

  if ! osascript -e 'id of application "OmniFocus"' &>/dev/null; then
    echo "Error: OmniFocus is not installed."
    return 1
  fi

  local script="tell application \"OmniFocus\"
  tell default document
    set folderExists to false
    try
      set folderExists to exists first flattened folder where name = \"Templates\"
    end try
    return folderExists
  end tell
end tell"

  local folder_exists=$(osascript -e "$script" 2>/dev/null)

  if [[ "$folder_exists" != "true" ]]; then
    echo "No Templates folder found in OmniFocus."
    return 1
  fi

  # Get templates
  script="tell application \"OmniFocus\"
  tell default document
    set templateFolder to first flattened folder where name = \"Templates\"
    set templateProjects to projects of templateFolder
    set templateNames to {}
    repeat with p in templateProjects
      set taskCount to count of tasks of p
      set end of templateNames to name of p & \" (\" & taskCount & \" tasks)\"
    end repeat
    return templateNames
  end tell
end tell"

  local result=$(osascript -e "$script" 2>/dev/null)

  # Check if the command was successful
  if [[ $? -ne 0 ]]; then
    echo "Error: Failed to retrieve OmniFocus templates."
    return 1
  fi

  # Format and display the templates
  if [[ -z "$result" ]]; then
    echo "No templates found in the Templates folder."
  else
    echo "OmniFocus Templates:"
    echo "$result" | tr ',' '\n' | sed 's/^ */- /'
  fi
}

# Create a quick OmniFocus entry with project and context
of-quick-entry() {
  # Check if running on macOS
  if [[ "$(uname)" != "Darwin" ]]; then
    echo "Error: OmniFocus integration is only available on macOS."
    return 1
  fi

  if ! osascript -e 'id of application "OmniFocus"' &>/dev/null; then
    echo "Error: OmniFocus is not installed."
    return 1
  fi

  # Open OmniFocus Quick Entry panel
  osascript -e 'tell application "OmniFocus" to activate' -e 'tell application "System Events" to keystroke "q" using {command down, option down}' &>/dev/null

  echo "OmniFocus Quick Entry panel opened."
  echo "Enter your task details and press Enter to save."
}

# Create a GTD weekly review workflow in OmniFocus
of-weekly-review() {
  # Check if running on macOS
  if [[ "$(uname)" != "Darwin" ]]; then
    echo "Error: OmniFocus integration is only available on macOS."
    return 1
  fi

  if ! osascript -e 'id of application "OmniFocus"' &>/dev/null; then
    echo "Error: OmniFocus is not installed."
    return 1
  fi

  local script="tell application \"OmniFocus\"
  tell default document
    set templateExists to false
    try
      set templateExists to exists first flattened project where name = \"Weekly Review\" and containing folder's name = \"Templates\"
    end try
    return templateExists
  end tell
end tell"

  local template_exists=$(osascript -e "$script" 2>/dev/null)

  # If the template doesn't exist, create it
  if [[ "$template_exists" != "true" ]]; then
    # Create the template
    of-template "Weekly Review"

    # Add standard GTD weekly review steps to the template
    script="tell application \"OmniFocus\"
    tell default document
      set templateFolder to first flattened folder where name = \"Templates\"
      set reviewTemplate to first project of templateFolder where name = \"Weekly Review\"
      tell reviewTemplate
        make new task with properties {name:\"1. Collect Loose Papers and Materials\"}
        make new task with properties {name:\"2. Get Inbox to Zero\"}
        make new task with properties {name:\"3. Process Notes\"}
        make new task with properties {name:\"4. Review Past Calendar Data\"}
        make new task with properties {name:\"5. Review Upcoming Calendar\"}
        make new task with properties {name:\"6. Review Waiting For List\"}
        make new task with properties {name:\"7. Review Project Lists\"}
        make new task with properties {name:\"8. Review Any Relevant Checklists\"}
        make new task with properties {name:\"9. Review Someday/Maybe List\"}
        make new task with properties {name:\"10. Review Reference Material\"}
        make new task with properties {name:\"11. Be Creative and Courageous\"}
      end tell
    end tell
  end tell"

    osascript -e "$script" &>/dev/null

    echo "Created Weekly Review template in OmniFocus."
  fi

  # Generate a date-specific name for this week's review
  local this_friday=$(date -v+fri +"%Y-%m-%d")
  local project_name="Weekly Review - $this_friday"

  # Create a new weekly review project from the template
  of-apply-template "Weekly Review" "$project_name"

  # Open the new project in OmniFocus
  script="tell application \"OmniFocus\"
  tell default document
    set reviewProject to first flattened project where name = \"$project_name\"
    tell front document window
      select reviewProject
    end tell
  end tell
  activate
end tell"

  osascript -e "$script" &>/dev/null

  echo "Weekly Review project created and opened in OmniFocus."
  echo "Follow the checklist to complete your GTD weekly review."
}
{{- end }}
