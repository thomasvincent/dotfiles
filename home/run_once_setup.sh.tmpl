#!/bin/bash
# run_once_setup.sh
# Managed by chezmoi - DO NOT EDIT DIRECTLY

set -euo pipefail

# Create productivity directories if enabled
{{ if .enable_productivity -}}
mkdir -p "{{ if and (hasKey . "preferences") (hasKey .preferences "task_dir") }}{{ .preferences.task_dir }}{{ else }}$HOME/.tasks{{ end }}"
mkdir -p "{{ if and (hasKey . "preferences") (hasKey .preferences "notes_dir") }}{{ .preferences.notes_dir }}{{ else }}$HOME/.notes{{ end }}"
mkdir -p "{{ if and (hasKey . "preferences") (hasKey .preferences "meeting_dir") }}{{ .preferences.meeting_dir }}{{ else }}$HOME/.notes/meetings{{ end }}"
mkdir -p "{{ if and (hasKey . "preferences") (hasKey .preferences "time_track_dir") }}{{ .preferences.time_track_dir }}{{ else }}$HOME/.timetrack{{ end }}"
{{ end -}}

# Set up the projects directory if workflows are enabled
{{ if .enable_workflows -}}
mkdir -p "{{ if and (hasKey . "preferences") (hasKey .preferences "projects_dir") }}{{ .preferences.projects_dir }}{{ else }}$HOME/Projects{{ end }}"
{{ end -}}

# Install required tools based on OS
if [[ "$(uname)" == "Darwin" ]]; then
    # macOS
    if command -v brew >/dev/null 2>&1; then
        echo "Installing tools with Homebrew..."
        # tmux and gh are already in Brewfile.tmpl
    else
        echo "Homebrew not found. Please install Homebrew first."
    fi
elif [[ "$(uname)" == "Linux" ]]; then
    # Linux
    if command -v apt-get >/dev/null 2>&1; then
        echo "Installing tools with apt..."
        sudo apt-get update
        sudo apt-get install -y tmux

        {{ if .enable_workflows -}}
        # Install GitHub CLI on Linux
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/etc/apt/trusted.gpg.d/githubcli-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture)] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list
        sudo apt-get update
        sudo apt-get install -y gh
        {{ end -}}
    elif command -v dnf >/dev/null 2>&1; then
        echo "Installing tools with dnf..."
        sudo dnf install -y tmux

        {{ if .enable_workflows -}}
        sudo dnf install -y 'dnf-command(config-manager)'
        sudo dnf config-manager --add-repo https://cli.github.com/packages/rpm/gh-cli.repo
        sudo dnf install -y gh
        {{ end -}}
    fi
fi

echo "Setup complete!"
