name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pre-commit

    - name: Run pre-commit
      run: pre-commit run --all-files

  test-linux:
    name: Test on Linux
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up environment
      run: |
        sudo apt-get update
        sudo apt-get install -y zsh

    - name: Test shell startup
      run: |
        chmod +x ./test_shell_startup.sh
        ./test_shell_startup.sh

  test-macos:
    name: Test on macOS
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v3

    - name: Test shell startup
      run: |
        chmod +x ./test_shell_startup.sh
        ./test_shell_startup.sh

  verify-templates:
    name: Verify Chezmoi Templates
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install Chezmoi
      run: |
        sh -c "$(curl -fsLS get.chezmoi.io)" -- -b $(pwd)/bin
        echo "$(pwd)/bin" >> $GITHUB_PATH

    - name: Verify templates
      run: |
        chezmoi execute-template < home/dot_zshrc.tmpl > /dev/null
        chezmoi execute-template < home/dot_zsh/cloud.zsh.tmpl > /dev/null
        chezmoi execute-template < home/dot_zsh/workflows.zsh.tmpl > /dev/null
        chezmoi execute-template < home/dot_zsh/productivity.zsh.tmpl > /dev/null
        chezmoi execute-template < home/dot_zsh/cicd.zsh.tmpl > /dev/null
        chezmoi execute-template < home/dot_zsh/dev_workflows.zsh.tmpl > /dev/null
        chezmoi execute-template < home/dot_zsh/app_workflows.zsh.tmpl > /dev/null
