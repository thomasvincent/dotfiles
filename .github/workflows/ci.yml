# =============================================================================
# CI Workflow for Dotfiles
# =============================================================================
#
# This workflow runs on every push and pull request to main.
# It validates shell scripts, tests shell startup, and verifies templates.
#
# Jobs:
#   - lint: Run pre-commit hooks (shellcheck, yamllint, etc.)
#   - test-linux: Test shell startup on Ubuntu
#   - test-macos: Test shell startup on macOS
#   - verify-templates: Ensure chezmoi templates are valid
#
# =============================================================================

name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Cancel previous runs on the same PR to save resources
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

# Minimal permissions for security
permissions:
  contents: read

jobs:
  # ===========================================================================
  # Lint Job
  # ===========================================================================
  # Runs pre-commit hooks to check code quality:
  # - shellcheck for shell scripts
  # - yamllint for YAML files
  # - trailing whitespace and EOF fixes
  # ===========================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

    - name: Verify CLAUDE.md exists
      run: test -f CLAUDE.md || (echo "Missing CLAUDE.md" && exit 1)

    - name: Set up Python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install pre-commit
      run: |
        python -m pip install --upgrade pip
        pip install pre-commit

    - name: Run pre-commit hooks
      run: pre-commit run --all-files

  # ===========================================================================
  # Linux Test Job
  # ===========================================================================
  # Tests that the shell configuration loads without errors on Linux.
  # This catches issues like missing commands or syntax errors.
  # ===========================================================================
  test-linux:
    name: Test on Linux
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y zsh bats

    - name: Run tests
      run: bats tests/shell_syntax.bats tests/duplicate_functions.bats tests/config_validation.bats tests/template_syntax.bats

  # ===========================================================================
  # macOS Test Job
  # ===========================================================================
  # Tests shell configuration on macOS, the primary target platform.
  # macOS has Zsh as the default shell since Catalina.
  # ===========================================================================
  test-macos:
    name: Test on macOS
    runs-on: macos-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

    - name: Install bats
      run: brew install bats-core

    - name: Run tests
      run: bats tests/shell_syntax.bats tests/duplicate_functions.bats tests/config_validation.bats tests/template_syntax.bats

  # ===========================================================================
  # Template Verification Job
  # ===========================================================================
  # Verifies that all chezmoi templates are syntactically valid.
  # This catches template errors before they break installation.
  # ===========================================================================
  verify-templates:
    name: Verify Chezmoi Templates
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

    - name: Install Chezmoi
      run: |
        sh -c "$(curl -fsLS get.chezmoi.io)" -- -b $(pwd)/bin
        echo "$(pwd)/bin" >> $GITHUB_PATH

    - name: Verify templates with minimal profile
      run: |
        FAILED=0
        for template in $(find home -name "*.tmpl" -type f 2>/dev/null); do
          echo "Verifying $template..."
          if chezmoi --config=tests/fixtures/chezmoi-minimal.toml execute-template < "$template" > /dev/null 2>&1; then
            echo "  OK"
          else
            echo "  FAILED"
            FAILED=1
          fi
        done
        if [ $FAILED -eq 0 ]; then
          echo "All templates verified successfully"
        else
          echo "Some templates failed verification"
          exit 1
        fi
